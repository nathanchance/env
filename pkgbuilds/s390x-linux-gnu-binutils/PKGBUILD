# Maintainer: Nathan Chancellor <nathan@kernel.org>

_target=s390x-linux-gnu
pkgname=$_target-binutils
pkgver=2.41
pkgrel=1
pkgdesc='A set of programs to assemble and manipulate binary and object files for the ARM EABI target'
arch=(x86_64)
url='https://gnu.org/software/binutils/'
license=(GPL)
depends=(glibc libelf zlib zstd)
makedepends=(setconf)
source=("https://ftp.gnu.org/gnu/binutils/binutils-$pkgver.tar.xz")
sha512sums=('5df45d0bd6ddabdce4f35878c041e46a92deef01e7dea5facc97fd65cc06b59abc6fba0eb454b68e571c7e14038dc823fe7f2263843e6e627b7444eaf0fe9374')

prepare() {
  setconf binutils-$pkgver/libiberty/configure ac_cpp "'\$CPP \$CPPFLAGS -O2'"
}

build() {
  cd "binutils-$pkgver"

  unset CPPFLAGS
  ./configure --disable-nls \
              --enable-colored-disassembly \
              --enable-deterministic-archives \
              --enable-gold \
              --enable-ld=default \
              --enable-multilib \
              --enable-plugins \
              --enable-targets=s390-linux-gnu \
              --prefix=/usr \
              --target=$_target \
              --with-gnu-as \
              --with-gnu-ld \
              --with-sysroot=/usr/$_target \
              --with-system-zlib
  make -O
}

package() {
  make -C "binutils-$pkgver" DESTDIR="$pkgdir" install

  # Remove info documents that conflict with host version
  rm -r "$pkgdir/usr/share/info"

  rm "$pkgdir"/usr/lib/bfd-plugins/libdep.so
}
