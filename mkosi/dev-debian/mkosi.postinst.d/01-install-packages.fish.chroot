#!/usr/bin/env fish

# Setup gh repo
set gh_gpg_key /etc/apt/keyrings/githubcli-archive-keyring.gpg
and curl -fLSs https://cli.github.com/packages/(basename $gh_gpg_key) | dd of=$gh_gpg_key
and echo "Types: deb
URIs: https://cli.github.com/packages
Suites: stable
Components: main
Signed-By: $gh_gpg_key" >/etc/apt/sources.list.d/github-cli.sources

# Setup LLVM repo
and set llvm_main_version (curl -fLSs https://raw.githubusercontent.com/llvm/llvm-project/main/cmake/Modules/LLVMVersion.cmake | string match -gr 'set\(LLVM_VERSION_MAJOR (\d+)\)'; or echo 20)
and set llvm_stable_version (math $llvm_main_version - 1)
and switch $ARCHITECTURE
    case arm64 x86-64
        set llvm_gpg_key /etc/apt/keyrings/apt-llvm-org.gpg
        curl -fLSs https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor -o $llvm_gpg_key
        and echo "Types: deb
URIs: https://apt.llvm.org/$RELEASE/
Suites: llvm-toolchain
Components: main
Signed-By: $llvm_gpg_key" >/etc/apt/sources.list.d/llvm-main.sources
        and echo "Types: deb
URIs: https://apt.llvm.org/$RELEASE/
Suites: llvm-toolchain-$llvm_stable_version
Components: main
Signed-By: $llvm_gpg_key" >/etc/apt/sources.list.d/llvm-stable.sources
        and set tc_packages {clang,lld,llvm}-$llvm_stable_version

    case '*'
        set tc_packages clang ll{d,vm}
end

# Download packages from repos
and apt update
and apt install -y \
    $tc_packages \
    gh
