#!/usr/bin/env fish

switch $DISTRIBUTION
    case arch
        echo 'session         optional        pam_umask.so' | tee -a /etc/pam.d/doas

    case fedora
        rm -f /etc/dnf/protected.d/sudo.conf

        if command -q dnf5
            set dnf dnf5
        else
            set dnf dnf
        end

        if $dnf list --installed sudo &>/dev/null
            $dnf remove -y sudo
            or return
        end

        ln -frsv /usr/{bin/doas,local/bin/sudo}

        set doas_pam /etc/pam.d/doas
        cp $doas_pam{,.new}
        echo 'session    optional     pam_umask.so' >>$doas_pam.new
        git --no-pager diff --no-index $doas_pam{,.new}
        mv $doas_pam{.new,}
end
