#!/usr/bin/env bash
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Shebang is purely for syntax highlighting and shellcheck auditing; script must be sourced to be useful
#
# Copyright (C) 2017-2021 Nathan Chancellor
#
# Utility and terminal setup functions for my remote workstation

# Clean up certain high volume git repos
function clean_repos() { (
    for REPO in "${ALS}"/* "${CBL}"/linux* "${CBL}"/wsl2 "${SRC_FOLDER}"/linux*; do
        header "${REPO}"
        if cd "${REPO}"; then
            git fetch --all
            git reflog expire --all --expire=now
            git gc --aggressive --prune=now --force
        else
            display_error "${REPO##*/} doesn't exist"
        fi
    done
    cd "${CBL_KC}" || die "${CBL_KC} does not exist"
    repo sync
    repo forall -c "git reflog expire --all --expire=now && git gc --aggressive --prune=now --force"
); }

# Qualify new LLVM revision
function qualify_llvm_uprev() { (
    bllvm --bootstrap || exit ${?}
    bllvm
); }

# Rebuild ~/usr
function rbld_usr() { (
    source "${SCRIPTS_FOLDER:?}"/env/stubs/updbin || die "Cannot source updbin"

    # Clean up PREFIX
    RBLD_USR_PREFIX=${PREFIX:-${USR_FOLDER:?}}
    RBLD_USR_STOW=${RBLD_USR_PREFIX}/stow
    if [[ -d ${RBLD_USR_STOW} ]]; then (
        header "Cleaning up stow directory"
        cd "${RBLD_USR_STOW}" || exit ${?}
        for PACKAGE in *-latest git prebuilts scripts; do [[ -d ${PACKAGE} ]] && stow -D -v "${PACKAGE}"; done
    ); fi
    rm -rf "${RBLD_USR_PREFIX:?}"/{bin,doc,include,lib,libexec,share}
    mkdir -p "${RBLD_USR_STOW}"

    # Distribution specific packages
    case "$(get_distro)" in
        arch)
            bgit || exit ${?}
            bcvise || exit ${?}
            ;;
        debian | ubuntu)
            updbin || exit ${?}
            bcttlfshtools || exit ${?}
            bdtc || exit ${?}
            iandroidtools || exit ${?}
            ;;
    esac

    # Binaries to install on any distribution
    iarc || exit ${?}
    ib4 || exit ${?}
    ituxmake || exit ${?}

    # Standalone kernel development scripts
    SCRIPTS_BIN=${RBLD_USR_STOW}/scripts/bin
    mkdir -p "${SCRIPTS_BIN}"
    for SCRIPT in "${SCRIPTS_FOLDER}"/kernel/*.sh; do
        ln -fsv "${SCRIPT}" "${SCRIPTS_BIN}"/"${SCRIPT##*/}"
    done
    stow -d "${RBLD_USR_STOW}" -v scripts

    # git functions
    GIT_BIN=${RBLD_USR_STOW}/git/bin
    mkdir -p "${GIT_BIN}"
    for SCRIPT in "${SCRIPTS_FOLDER}"/git/*; do
        ln -fsv "${SCRIPT}" "${GIT_BIN}"/git-"${SCRIPT##*/}"
    done
    stow -d "${RBLD_USR_STOW}" -v git

    # Self compiled ToT LLVM
    if [[ -d ${LLVM_TC_FOLDER} ]]; then
        # This will never not be alphanumeric and find is insanely convoluted
        # shellcheck disable=SC2012
        DATE=$(command ls -1ht "${LLVM_TC_FOLDER}" | head -n1)
        [[ -n ${DATE} ]] && stow_llvm "${DATE}"
    fi
); }

# Do a full system LLVM update
function updllvm() { (
    LLVM_SRC=${SRC_FOLDER:-${HOME}/src}/llvm-project
    [[ -d ${LLVM_SRC} ]] || git clone https://github.com/llvm/llvm-project "${LLVM_SRC}"
    git -C "${LLVM_SRC}" pull --rebase

    qualify_llvm_uprev && updpgollvm
); }

# Alias for running PGO LLVM build
function updpgollvm() { (
    DATE=$(date +%F)
    PREFIX=${LLVM_TC_FOLDER}/${DATE} bpgollvm &&
        stow_llvm "${DATE}" &&
        ccache_clear llvm
); }

# Additional setup steps for my workstation
function workstation_setup() {
    # Generate a kernel version for the current tree
    alias kver='make -s kernelversion'

    ccache_setup 100
    source "${SCRIPTS_FOLDER}"/env/stubs/bldgcc
    source "${SCRIPTS_FOLDER}"/env/stubs/cbl
    load_botinfo
    gpg_key_cache
}
# vi: filetype=zsh
